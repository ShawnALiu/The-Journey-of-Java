# 一、敏感信息泄露

## 1.简介

敏感信息：个人信息、系统版本信息、认证信息、标识信息等。具体包括但不限于：口令、密钥、证书、会话标识、License、隐私数据、授权凭据、个人数据等。

Web应用和API无法正确保护敏感数据，攻击者通过窃取或修改数据实施信用卡盗窃、身份盗窃、攻击业务系统或其他犯罪。

## 2.场景

（1）敏感数据传输。从客户端到服务端。

（2）敏感信息显示。在客户端显示。

（3）代码或内部文档泄露。

（4）客户端代码注释。注释里存在测试环境ip，服务器账号等。

（5）不安全的处理。没有处理异常就可能讲绝对路径、数据库连接等信息返回到前端。

## 3.措施

（1）敏感数据加密传输。采用安全的SSL加密通道，或者敏感信息额外加密传输，最小化信息传输到客户端。

（2）敏感数据加密存储。不采集非必要数据，必要的敏感数据加密存储或者脱敏存储。

（3）统一修改Web中间件版本名称、统一展示页面等。

（4）禁止数据外传。禁止上传公司任何代码到github、博客等。

# 二、未授权访问

## 1.简介

缺乏认证机制、授权页面存在缺陷、配置不当等原因，导致可以直接访问系统后台或服务。通过未授权访问漏洞，通常可以获取到系统的敏感信息，甚至可以直接读取数据库、执行系统命令，从而获取服务器的权限。

## 2.场景

（1）前端路由。通过返回标识来判断是否可以访问。

（2）未进行登陆态鉴权的重要操作接口。

（3）未开启认证功能的组件。如redis。

## 3.措施

（1）对敏感操作接口进行鉴权。涉及系统配置更改，获取系统信息的接口需要设置鉴权机制。

（2）开启组件的鉴权机制。

（3）限制组件、服务的公网访问。

# 三、CC攻击

## 1.简介

拒绝服务（DoS）攻击：恶意行为者通过中断设备的正常功能，使目标用户无法使用计算机或其他设备。DoS攻击通常通过请求压垮或淹没目标计算机，使其无法处理正常流量，从而对其他用户造成拒绝服务。

CC攻击是DoS攻击的一种，其攻击流程是模拟正常用户对一些比较消耗资源的网页进行请求。在web应用中，查询数据库、读写硬盘文件等操作都是比较消耗资源的。

## 2.场景

（1）消耗较多CPU资源进行复杂实时计算。如动态页面等。

（2）消耗较多内存资源进行频繁读写数据库。如搜索、查询等。

（3）长期占用网络连接消耗I/O资源。如文件上传、文件下载、连接数据库查询等。

## 3.措施

（1）web服务端区分攻击者与正常访客。可以将新、老用户区分至不同的服务器群，再从中找异常用户，或者通过风控对用户进行识别。

（2）限制IP连接数。通过WAF、防火墙、nginx server调整单个IP的限制连接数，每分钟最大请求次数，设置一定的阈值，动态调整。当某IP超过阈值后，进行拦截或者黑名单处理。

（3）使用缓存，减少磁盘IO。考虑基于内存的缓存服务，减少数据库的检索次数。

（4）读写分离。

（5）优化核心代码。在关键接口或核心代码处，尽可能使用缓存来重复的查询内容；减少重复数据查询资源开销；减少复杂框架调用；减少不必要的数据请求和处理逻辑；及时释放资源；对查询语句进行优化，减少慢SQL；非核心功能必要时进行降级保护核心功能。

# 四、XSS

## 1.简介

向Web页面里插入恶意Script代码。

分类：①DOM型XSS；②存储型XSS；③反射型XSS。

危害：

（1）Cookie窃取：js在网站未开启Httponly保护的情况下，js可以通过document.cookie拿到浏览xss漏洞的用户Cookie，再通过js创建表单，submit到指定网站。

（2）网络钓鱼：通过js代码 document.location.href=“钓鱼网站url”。

（3）js挖矿：coinhive专门提供一个用来挖矿的js引擎。

（4）探测内网端口：通过ajax发送请求，根据返回判断端口开房情况。

## 2.场景

（1）在前端使用location.href等方式实现页面跳转。

（2）取页面数值重新写入页面或动态执行。

（3）论坛和博客的发帖、评论系统、直播的弹幕系统等。

（4）涉及填写的个人信息内容，如昵称、地址、签名等。

（5）使用富文本等应用场景，富文本编写内容会进行存储。

## 3.措施

（1）严格的输入校验。校验输入的类型、长度、格式。

（2）输出编码（最终解决方案）。针对所有的输出进行HTML实体编码。①服务端可以使用org.owasp.encoder转义库工具。②前段可以用模板本身的过滤方式，如Vue使用{{}}，ftl模板<#escape x as x?html>

（3）采用白名单机制。仅允许使用白名单列表的参数值。

转义是防范XSS攻击的最佳方式

![](../assets/images/%E5%AE%89%E5%85%A8/1/1.png)

# 五、配置不当

## 1.简介

利用服务端不正确的安全配置（开放多余的端口、未及时修复的漏洞、默认账户密码、多余的信息泄露等）来取得对系统的未授权访问或者发起攻击。

## 2.场景

（1）应用程序堆栈的不同层缺少适当的安全加固。

（2）应用程序启动或者安装了不必要的功能（不必要的端口、服务、网页、账户、权限）。如swagger组件，导致接口信息泄露；webpack组件在生产环境未关闭相应配置，导致前端源码泄露；系统监控组件未限制访问（如spring actuator），导致系统环境信息、运行信息泄露。

（3）错误处理机制向用户披露堆栈跟踪或者大量错误信息。导致可以从堆栈中还原出服务的配置信息。

（4）应用程序框架、库文件、数据库等没有进行安全配置。导致可被远程访问、未授权访问。

（5）引用组件的默认高权限配置未进行修改。敏感操作可以被恶意执行。

## 3.措施

（1）修改组件默认配置。在引入组件时，详细阅读指引，对默认配置进行修改。

（2）禁用不必要的功能。如不必要的端口（只开放80，443，8080），不必要的服务（如swagger，actuator），不必要的账号、权限。

（3）对组建进行安全加固。修改数据库默认账号、配置数据库访问白名单、删除tomcat示例文件等。

（4）统一错误信息。

# 六、SQL

## 1.简介

在提交的参数中，插入 SQL 语句或者命令，然后提交到服务器端，服务器在处理该参数时，将该参数拼接到SQL语句中，导致攻击者插入的SQL代码或者命令被执行。

## 2.场景

（1）用户密码登陆场景，通过SQL注入获得所有用户及数据库信息。数据库信息泄露。

（2）数据查询、插入、更新、删除场景。通过前台传入语句，进行SQL拼接。修改数据库数据。

（3）利用数据库的某些功能，向操作系统发出指令，获取服务器控制权限。

## 3.措施

（1）严格的输入校验。

（2）使用预编译语句，绑定变量。如java，使用PrepareStatement。

（3）MyBatis使用细节。#{}经过预编译的，安全的；\${}未经过预编译，仅仅取变量的值，是非安全的。涉及到动态表名、列名，只能使用${}，必须在代码中手工进行校验。

# 七、SSRF

## 1.简介

许多Web会提供从其他Web服务器获取数据的功能，用户提交指定的URL可以从Web应用程序获取图像，从远程服务器获取xml源文件、文本文件等。攻击者通过将URL换成内网地址，就能获取内网信息或发起攻击。

危害：

（1）对本地、外网、服务器所在内网进行端口扫描，获取服务的banner信息。

（2）攻击运行在内网、本地的应用程序。

（3）对内网web应用进行指纹识别，可通过访问默认文件实现。

（4）攻击内外网的web应用，使用get参数就可以实现攻击，比如structs、sqli等。

（5）利用file协议读取本地文件(curl)。

## 2.场景

（1）分享。通过URL地址分享网页内容。

（2）转码服务。通过URL地址把原地址的网页内容调优，使其适合手机屏幕浏览。

（3）在线翻译。通过URL地址翻译对应的文本内容。

（4）图片加载与下载：通过URL地址加载或下载图片。

（5）图片、文章收藏功能。

（6）未公开的api实现，以及其他调用URL功能。

## 3.措施

（1）限制请求端口。限制请求端口为http常用端口，80、443、8080。

（2）禁用不需要的协议。如 file://、gopher://、ftp://。

（3）内网IP黑名单。禁止发出内网IP请求。

（4）访问资源白名单。

（5）统一错误信息。

# 八、越权

## 1.简介

权限控制功能实现存在缺陷，可以绕过需要验证当前身份权限的功能、文件，进行访问并操作。

分类：

（1）横向越权：彼此权限等级相同，某恶意用户尝试crud其他用户的内容。

（2）纵向越权：低级别权限的恶意用户尝试访问高级别用户的内容。

危害：

（1）导致个人的敏感信息泄露、恶意篡改、删除。

（2）普通用户获得更敏感的权限，从而破坏系统。

## 2.场景

（1）用户未登录就被允许访问登陆后才允许访问的页面。

（2）针对多权限分的场景，不同权限的功能校验可能存在遗漏。

（3）多用户系统根据用户ID标识操作，如身份ID、手机号、证件号。

（4）文件操作场景，仅根据文件名、文件标识ID去访问或者下载文件。

（5）数据操作场景，根据操作对象ID为标识进行访问操作。如订单号、任务号、记录编号等。

## 3.措施

（1）服务端通过用户登录的session、token来识别用户身份。

（2）校验当前登录的用户是否有目前功能的操作权限。

# 九、XML注入

## 1.简介

XML（可扩展标记语言），采用XML作为前端和后端进行数据传输的格式，服务端又允许使用外部实体时，如未对提交的XML文件引用的外部实体做合适的处理，就可以利用XML外部实体注入来进行攻击。

XML外部实体注入又叫XXE，危害：

（1）读取任意文件。如通过file协议请求文件路径，得到文件信息。

（2）探测内网端口。可遍历内网服务和端口。

（3）与其他漏洞组合应用。如通过http进行ssrf，配合内网redis未授权访问，可获取服务器权限，威胁内网。

（4）执行系统命令。

（5）导致DOS攻击。构造恶意的XML实体文件，耗尽可用内存（著名的“billion laughs”）。

## 2.场景

（1）服务端支持上传XML处。如word、excel等。

（2）文件在线预览处。

（3）第三方的SDK、框架等。如一些支付业务SDK暴露出XML注入漏洞。

## 3.措施

（1）禁止加载外部实体。dbf.setFeature("`http://apache.org/xml/features/disallow-doctype-decl`", true)。

（2）不允许XML中含有任何自己声明的DTD。

# 十、逻辑缺陷

## 1.简介

由于程序逻辑不严、逻辑太复杂，导致一些分支不能正常处理错误。

## 2.场景

账号体系类逻辑漏洞：

（1）通过验证码爆破，对验证码有效期、请求次数没有进行限制。

（2）token验证之类。直接将验证内容返回给用户客户端。

（3）在找回密码功能方面，进行身份验证的内容未加密、或者加密算法较弱。

（4）用户身份验证在前端进行，导致可以被抓包绕过。

（5）修改密码功能，没有校验账号是否通过了验证，短信与手机号是否对应。

支付体系类逻辑漏洞：

（1）直接修改数据包中的支付金额。

（2）未考虑购买负数情况。

（3）高并发请求重放。购买成功后，重放请求数据包，实现付一买十。

（4）使用第三方支付。购买者可以在下单并收到货物后，在第三方平台申请退款，可以在收到商品同时获得退款。

## 3.措施

账号体系类：

（1）对验证码进行有效期、请求次数限制，增加验证码复杂度。

（2）token验证不要直接返回给用户，session使用后就销毁。

（3）用户身份验证一定要在后台实现，接受验证码的账号由服务端提供，不能信任客户端提交的数据。

（4）密码找回时，凭证不能下发给客户端，校验邮箱是否有效应该添加图片验证码来防止关键信息被篡改。

（5）密码找回逻辑中含有用户标识（用户名、用户ID、cookie）、接收端（手机、邮箱）、凭证（验证码、token）、当前步骤四个要素。四要素必须完整关联，否则还会导致任意密码重置漏洞。

支付体系类：

（1）和银行交易时，做数据签名，对用户金额、订单签名。

（2）敏感参数不要放在url里。

（3）服务端计算金额时，一定要判断是否为正数。提交订单时，判断单价是否和数据库一致。

（4）订单要进行多重校验。

# 十一、CSRF

## 1.简介

CSRF（Cross-site reruest forgery）的中文名称叫做跨站请求伪造。从用户登陆某网站后，攻击者骗过浏览器，向用户已认证登录信息的网站发送恶意操作请求。

## 2.场景

（1）添加、修改、删除任何的个人信息。

## 3.措施

（1）严格校验referer字段。即比对请求的来源地址。

（2）使用token。在请求中附加随机性的token。

（3）验证码。

# 十二、URL重定向

## 1.简介

服务端未对传入的url进行检查和控制，导致诱导用户跳转到恶意网站。

实现方式：

（1）META标签内跳转。

（2）javascript跳转。

（3）header头跳转。

## 2.场景

（1）用户分享、收藏后，跳转。

（2）用户登录、认证后，跳转。

（3）跨站点认证、授权后，跳转。

（4）站内点击其他网址链接时，跳转。

## 3.措施

（1）白名单列表，限制跳转地址。

（2）跳转地址采用映射机制。如 1->baidu，2->meituan

（3）校验URL。常用正则匹配。

# 十三、CORS

## 1.简介

CORS跨域资源共享（Cross-origin resource sharing），是H5提供的机制。Web应用程序可以在http增加字段告诉浏览器，那些不同来源地服务器是有权访问本站资源的。当不同域的请求发生时，就出现了跨域现象。它允许浏览器向跨源（协议+域名+端口）服务器，发出XMLHttpRequest请求，从而克服了Ajax只能同源使用的限制。

危害：

（1）泄露用户数据。

（2）客户端、服务端缓存中毒。

## 2.场景

（1）前后端分离的模式下，前后端域名不一致。请求中没有Origin header，响应中也没有对应的Access-Control-Allow-Origin、 Access-Control-Allow-Credential等header。

（2）本地开发时，本地文件夹并不是在一个域下面。

（3）子站域名希望调用主站域名的用户资料接口，并将数据显示出来。

## 3.措施

（1）Access-Control-Allow-Origin 配置为同源域名。

（2）Access-Control-Allow-Credential 尽量配置为false。

（3）严格校验来自请求的Origin。

（4）Access-Control-Allow-Methods、 Access-Control-Allow-Headers，限制浏览器缓存时间。
