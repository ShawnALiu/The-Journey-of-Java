
# 1.服务器中的数据库

数据库保存在服务器redis.h/redisServer的db数组中，db数组的每个项都是一个redis.h/redisDb结构， 每个redisDb结构代表一个数据库：

```C
struct redisServer {
    
    //一个数组， 保存着服务器中的所有数据库
    redisDb *db;

    //服务器的数据库数量
    int dbnum;

    // ...
};
```

dbnum属性的值由服务器配置的database选项决定，默认情况下，该选项的值为16，即Redis服务器默认会创建16个数据库。

# 2.切换数据库

每个Redis客户端都有目标数据库，默认情况下，为0号数据库，可以通过执行SELECT命令来切换目标数据库。

```C
redis> SELECT 2
OK
```

# 3.数据库键空间

redisDb结构的dict字典保存了数据库中的所有键值对，称为键空间（key space）：

```C
typedef struct redisDb {

    //数据库键空间，保存着数据库中的所有键值对
    dict *dict;
    
    // ...
} redisDb;
```

## 3.1 添加

将一个新键值对添加到键空间字典里面。

## 3.2 删除

在键空间里面删除键所对应的键值对对象。

## 3.3 更新

对键空间里面键所对应的值对象进行更新，根据值对象的类型不同，更新的具体方法也会有所不同。

## 3.4 查询

在键空间中取出键所对应的值对象，根据值对象的类型不同，具体的取值方法也会有所不同。

# 4.过期时间

## 4.1 设置过期时间

（1）EXPIRE <key> <ttl> 命令用于将键key的生存时间设置为ttl秒。

（2）PEXPIRE <key> <ttl> 命令用于将键key的生存时间设置为ttl毫秒。

（3）EXPIREAT <key> <timestamp> 命令用于将键key的过期时间设置为timestamp所指定的秒数时间戳。

（4）PEXPIREAT <key> <timestamp> 命令用于将键key的过期时间设置为timestamp所指定的毫秒数时间戳。

## 4.2 保存过期时间

redisDb结构的expires字典保存了数据库中所有键的过期时间，称这个字典为过期字典：

- 过期字典的键是一个指针，指向键空间中的某个键对象（也即是某个数据库键）。
- 过期字典的值是一个long long类型的整数，保存了数据库键的过期时间——一个毫秒精度的UNIX时间戳。

```C
typedef struct redisDb {

    //过期字典， 保存着键的过期时间
    dict *expires;
    
    // ...
} redisDb;
```

## 3.3 移除过期时间

PERSIST命令可以移除一个键的过期时间：

```C
redis> PERSIST message
(integer) 1
```

## 4.3 计算剩余时间

TTL命令以秒为单位返回剩余生存时间，而PTTL命令则以毫秒为单位返回：

```C
redis> TTL alphabet
(integer) 8549007
redis> PTTL alphabet
(integer) 8549001011
```

## 4.4 判定过期

按以下步骤检查一个键是否过期：

（1）检查键是否存在过期字典：如果存在，那么取得键的过期时间。

（2）检查当前UNIX时间戳是否大于键的过期时间：如果是的话，那么键已经过期；否则，未过期。


## 4.5 过期删除策略

有3种过期删除策略：定时删除、惰性删除、定期删除。Redis服务器**实际使用的是惰性删除和定期删除两种**策略。

（1）定时删除

在设置过期时间的同时，创建一个定时器（timer），让定时器在键的过期时间来立即删除键。

优点：

①保证过期键会尽可能快地被删除，并释放所占用的内存。

缺点：

①对CPU时间不友好的：在过期键比较多的情况下，可能会占用相当一部分CPU时间。影响服务器的响应时间和吞吐量。

②创建定时器需要用到Redis服务器中的时间事件（无序链表），查找一个事件的时间复杂度为O（N），因此并不能高效地处理大量时间事件。

（2）惰性删除

放任键过期不管，但是每次从键空间中获取键时，都检查取得的键是否过期，如果过期的话，就删除该键；如果没有过期，就返回该键。由db.c/expireIfNeeded函数实现。

优点：

①对CPU时间友好。

缺点：

①对内存不友好，过期键不被删除，它所占用的内存就不会释放。

如果有大量过期键，而这些过期键又恰好没有被访问，那么它们永远不会被删除（除非用户手动执行FLUSHDB），可以将这种情况看作是一种内存泄漏。

（3）定期删除

每隔一段时间，程序就对数据库进行一次检查，删除里面的过期键。

由redis.c/activeExpireCycle函数实现，在规定的时间内，分多次遍历服务器中的各个数据库，从数据库的expires字典中随机检查一部分键的过期时间，并删除其中的过期键。。

定期删除策略是前两种策略的一种整合和折中，难点是确定删除操作执行的时长和频率。

## 4.6 RDB、AOF和复制功能对过期键的处理

（1）生成RDB文件

在执行SAVE命令或者BGSAVE命令创建一个新的RDB文件时，已过期的键不会被保存到该RDB文件中。

（2）载入RDB文件

启动Redis服务器时，如果开启了RDB功能，那么服务器将对RDB文件进行载入：

- 如果服务器以主服务器模式运行，在载入RDB文件时，只会将未过期的键载入到数据库中，所以过期键对载入RDB文件的主服务器不会造成影响。
- 如果服务器以从服务器模式运行，在载入RDB文件时，文件中保存的所有键，都会被载入到数据库中。当主从同步时，从服务器的数据库会被清空，所以，过期键对载入RDB文件的从服务器也不会造成影响。

（3）AOF文件写入

当服务器以AOF持久化模式运行时：

- 如果键已过期，但还没有被删除，那么AOF文件不会因为这个过期键而产生任何影响。
- 当过期键被删除后，程序会向AOF文件追加（append）一条DEL命令，来显式地记录该键已被删除。

（4）AOF重写

和生成RDB文件类似，在AOF重写时，已过期的键不会被保存到重写后的AOF文件中。

（5）复制

当服务器运行在复制模式下时，从服务器的过期键删除动作由主服务器控制：

- 主服务器在删除过期键之后，会显式地向所有从服务器发送一个DEL命令。
- 从服务器在执行客户端发送的读命令时，即使碰到过期键也不会将过期键删除，而是继续像处理未过期的键一样来处理过期键。
- 从服务器只有在接到主服务器发来的DEL命令之后，才会删除过期键。

由主服务器来控制从服务器，统一地删除过期键，可以保证主从服务器数据的一致性。

# 5.数据库通知

数据库通知是Redis 2.8版本新增加的功能，通过订阅给定的频道或者模式，让客户端来获知数据库中键的变化，以及命令的执行情况。
